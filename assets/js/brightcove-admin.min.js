( function( $ ){

var MediaModel=Backbone.Model.extend({sync:function(e,t,i){var s=null;if(_.find(wpbc.preload.accounts,function(e,t){if(e.account_id===this.get("account_id"))return s=t,!0},this),_.isUndefined(this.id))return $.Deferred().rejectWith(this).promise();if("read"===e)return i=i||{},i.context=this,i.data=_.extend(i.data||{},{action:"bc_media_fetch",id:this.id}),wp.media.ajax(i);if("update"===e){(i=i||{}).context=this,i.data=_.extend(i.data||{},{account:s,action:"bc_media_update",description:this.get("description"),long_description:this.get("long_description"),name:this.get("name"),nonce:wpbc.preload.nonce,tags:this.get("tags"),type:this.get("mediaType"),custom_fields:this.get("custom_fields"),history:this.get("_change_history"),poster:this.get("poster"),thumbnail:this.get("thumbnail"),captions:this.get("captions")});var a=this.get("video_ids");return a?(i.data.playlist_id=this.id,i.data.playlist_videos=a,i.data.type="playlists"):i.data.video_id=this.id,i.success=this.successFunction,i.error=this.failFunction,wpbc.broadcast.trigger("spinner:on"),wp.media.ajax(i)}if("delete"===e){var o=this;return(i=i||{}).data=_.extend(i.data||{},{account:s,action:"bc_media_delete",id:this.get("id"),nonce:wpbc.preload.nonce,type:this.get("mediaType")}),wp.media.ajax(i).done(function(e){o.destroyed=!0,wpbc.broadcast.trigger("delete:successful",e),"videos"!==o.get("mediaType")&&_.isUndefined(o.get("video_ids"))?wpbc.preload.playlists=void 0:wpbc.preload.videos=void 0,wpbc.responses={}}).fail(function(e){o.destroyed=!1,wpbc.broadcast.trigger("videoEdit:message",e,"error"),wpbc.broadcast.trigger("spinner:off")})}return Backbone.Model.prototype.sync.apply(this,arguments)},parse:function(e){return e?(e.date=new Date(e.date),e.modified=new Date(e.modified),e):e},getAccountName:function(){this.get("account_id");var e=_.findWhere(wpbc.preload.accounts,{account_id:this.get("account_id")});return void 0===e?"unavailable":e.account_name},getReadableDuration:function(){var e=this.get("duration");if(e){e=Number(e/1e3);var t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%3600%60);return(t>0?t+":"+(i<10?"0":""):"")+i+":"+(s<10?"0":"")+s}return e},getReadableDate:function(e){var t=this.get(e);if(t){var i=new Date(t),s=i.getHours(),a=i.getMinutes(),o=i.getFullYear(),d=i.getMonth()+1,n=i.getDate(),l=s>=12?"pm":"am";return o+"/"+d+"/"+n+" - "+(s=(s%=12)||12)+":"+(a=a<10?"0"+a:a)+" "+l}return t},successFunction:function(e){if(wpbc.broadcast.trigger("videoEdit:message",e,"success"),wpbc.broadcast.trigger("spinner:off"),_.isArray(this.get("video_ids"))&&wpbc.preload&&wpbc.preload.playlists){var t=this.get("id");_.each(wpbc.preload.playlists,function(e,i){e.id===t&&(wpbc.preload.playlists[i]=this.toJSON())},this)}wpbc.responses={},"videos"!==this.get("mediaType")&&_.isUndefined(this.get("video_ids"))?wpbc.preload.playlists=void 0:wpbc.preload.videos=void 0},failFunction:function(e){wpbc.broadcast.trigger("videoEdit:message",e,"error"),wpbc.broadcast.trigger("spinner:off")}}),MediaCollection=Backbone.Collection.extend({model:MediaModel,initialize:function(e,t){(t=t||{}).activeAccount&&(this.activeAccount=t.activeAccount),this.additionalRequest=!1,this.pageNumber=this.pageNumber||1,this.mediaType||"existingPlaylists"!==this.mediaCollectionViewType&&"libraryPlaylists"!==this.mediaCollectionViewType||(this.mediaType="videos"),this.mediaCollectionViewType=t.mediaCollectionViewType||"grid",t.excludeVideoIds&&"libraryPlaylists"===t.mediaCollectionViewType&&(this.excludeVideoIds=t.excludeVideoIds),t.videoIds&&!e?(this.mediaType="videos",this.videoIds=t.videoIds,this.fetch()):"playlists"!==t.mediaType&&(this.mediaType="videos",this.fetch()),this.mediaType=t.mediaType,"videos"===this.mediaType&&this.listenTo(wpbc.broadcast,"uploader:uploadedFileDetails",function(e){this.add(e,{at:0})}),this.activeAccount=t.activeAccount||"all",this.searchTerm=t.searchTerm||"",this.dates=t.dates||"all",this.tag=t.tag||"",this.listenTo(wpbc.broadcast,"change:activeAccount",function(e){this.activeAccount=e,wp.heartbeat.enqueue("brightcove_heartbeat",{accountId:e},!0),this.fetch()}),$(document).on("heartbeat-tick.brightcove_heartbeat",function(e,t){t.hasOwnProperty("brightcove_heartbeat")&&wp.heartbeat.enqueue("brightcove_heartbeat",{accountId:t.brightcove_heartbeat.account_id},!0)}),this.listenTo(wpbc.broadcast,"change:searchTerm",function(e){this.searchTerm=e,this.fetch()}),this.listenTo(wpbc.broadcast,"change:tag",function(e){"all"===e&&(e=""),this.tag=e,this.fetch()}),this.listenTo(wpbc.broadcast,"change:date",function(e){this.date=e,this.fetch()}),this.listenTo(wpbc.broadcast,"tabChange",function(e){if(this.killPendingRequests(),e.mediaType!==this.mediaType){this.mediaType=e.mediaType;for(var t,i=wpbc.preload[this.mediaType];t=this.first();)this.remove(t);void 0!==i?this.add(i):this.fetch()}})},killPendingRequests:function(){_.each(wpbc.requests,function(e){e.abort()}),wpbc.requests=[]},checksum:function(e){_.isString(e)||(e=_.isFunction(e.toJSON)?e.toJSON():JSON.stringify(e));for(var t=305419896,i=0;i<e.length;i++)t+=e.charCodeAt(i)*(i+1);return t},sync:function(e,t,i){if("read"===e){(i=i||{}).data=_.extend(i.data||{},{action:"bc_media_query",account:this.activeAccount||wpbc.preload.defaultAccountId,dates:this.date,posts_per_page:wpbc.posts_per_page,page_number:this.pageNumber,nonce:wpbc.preload.nonce,search:this.searchTerm,tags:this.tag,tagName:wpbc.preload.tags[this.tag],type:this.mediaType||"videos"});var s=_.pick(i.data,"account","dates","posts_per_page","search","tags","type");this.additionalRequest=_.isEqual(s,wpbc.previousRequest),this.additionalRequest||(i.data.page_number=1),"existingPlaylists"!==this.mediaCollectionViewType&&(wpbc.previousRequest=s),this.videoIds&&(i.data.videoIds=this.videoIds.length?this.videoIds:"none"),i.data.query=void 0,_.contains(["libraryPlaylists","existingPlaylists"],this.mediaCollectionViewType)||this.killPendingRequests();var a=this.checksum(i.data);if(!_.isUndefined(wpbc.responses[a]))return this.parse({data:wpbc.responses[a]},"cached"),!0;var o=$.ajax({type:"POST",url:wp.ajax.settings.url,context:this,data:i.data}).done(function(e,t,i){this.parse(e,t,i,a)}).fail(this.fetchFail);return wpbc.requests.push(o),wpbc.broadcast.trigger("spinner:on"),o}return(MediaCollection.prototype.sync?MediaCollection.prototype:Backbone).sync.apply(this,arguments)},fetchFail:function(){this.pageNumber>1&&this.pageNumber--,wpbc.broadcast.trigger("fetch:finished"),wpbc.broadcast.trigger("spinner:off"),wpbc.broadcast.trigger("fetch:apiError"),status},parse:function(e,t,i,s){if(wpbc.broadcast.trigger("fetch:finished"),wpbc.broadcast.trigger("spinner:off"),!_.contains(["success","cached"],t)||"cached"!==t&&!e.success)return wpbc.broadcast.trigger("fetch:apiError"),!1;var a=e.data;if("success"===t&&(wpbc.responses[s]=a),!1===a)return!1;_.isArray(a)||(a=[a]),_.isArray(this.excludeVideoIds)&&_.each(this.excludeVideoIds,function(e){a=_.without(a,_.findWhere(a,{id:e}))});var o=_.map(a,function(e){var t,i,s;return e instanceof Backbone.Model?(t=e.get("id"),e=e.attributes):t=e.id,(i=this.findWhere({id:t}))?(s=i.parse(e),_.isEqual(i.attributes,s)||i.set(s)):i=this.add(e),i.set("viewType",this.mediaCollectionViewType),i},this);this.additionalRequest?this.add(o):this.set(o)}}),BrightcoveMediaManagerModel=Backbone.Model.extend({defaults:{view:"grid",date:"all",tags:"all",type:null,preload:!0,search:"",account:wpbc.preload.defaultAccountId,poster:{},thumbnail:{}},initialize:function(e){_.defaults(e,this.defaults),wp.heartbeat.enqueue("brightcove_heartbeat",{accountId:wpbc.preload.defaultAccountId},!0);var t=new MediaCollection([],{mediaType:e.mediaType});t.reset(),e.preload&&e.preload.length&&t.add(e.preload),e.preload=!!e.preload,this.set("media-collection-view",new MediaCollectionView({collection:t})),this.set("options",e)}}),BrightcoveModalModel=Backbone.Model.extend({getMediaManagerSettings:function(){var e=this.get("tab"),t={upload:{accounts:"all",date:"all",embedType:"modal",mediaType:"videos",mode:"uploader",preload:!0,search:"",tags:"all",viewType:"grid",poster:{},thumbnail:{}},videos:{accounts:"all",date:"all",embedType:"modal",mediaType:"videos",mode:"manager",preload:!0,search:"",tags:"all",viewType:"grid"},playlists:{accounts:"all",date:"all",embedType:"modal",mediaType:"playlists",mode:"manager",preload:!0,search:"",tags:"all",viewType:"grid"}};return void 0!==t[e]&&t[e]}}),UploadModelCollection=Backbone.Collection.extend({initialize:function(e){this.listenTo(wpbc.broadcast,"uploader:queuedFilesAdded",this.queuedFilesAdded)},queuedFilesAdded:function(e){_.each(e,function(e){this.add(new UploadModel(e))},this)}}),UploadModel=Backbone.Model.extend({initialize:function(e){},humanReadableSize:function(){var e=this.get("size");if(0===e)return"0 Byte";var t=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,i)).toPrecision(3)+" "+t[i]}}),BrightcoveView=wp.Backbone.View.extend({subviews:null,registerSubview:function(e){this.subviews=this.subviews||[],this.subviews.push(e)},remove:function(){_.invoke(this.subviews,"remove"),wp.Backbone.View.prototype.remove.call(this)},insertShortcode:function(){if(this.model){var e=this.model.get("id").replace(/\D/g,""),t=this.model.get("account_id").replace(/\D/g,""),i="";if(!(s=wpbc.selectedPlayer))var s="default";if(void 0!==this.mediaType)i="videos"===this.mediaType?'[bc_video video_id="'+e+'" account_id="'+t+'" player_id="'+s+'"]':'[bc_playlist playlist_id="'+e+'" account_id="'+t+'"]';else{var a=wp.template("brightcove-mediatype-notice");$("#lost-connection-notice").before(a),$("#js-mediatype-dismiss").on("click",function(){$("#js-mediatype-notice").first().fadeOut(500,function(){$(this).remove()})})}window.send_to_editor(i),wpbc.broadcast.trigger("close:modal")}}}),ToolbarView=BrightcoveView.extend({tagName:"div",className:"media-toolbar wp-filter",template:wp.template("brightcove-media-toolbar"),events:{"click .view-list":"toggleList","click .view-grid":"toggleGrid","click .brightcove-tooltip":"toggleTooltip","change .brightcove-media-source":"sourceChanged","change .brightcove-media-dates":"datesChanged","change .brightcove-media-tags":"tagsChanged","change .brightcove-empty-playlists":"emptyPlaylistsChanged","search .search":"searchHandler","keyup  .search":"searchHandler"},render:function(){var e=this.model.get("mediaType"),t={accounts:wpbc.preload.accounts,dates:{},mediaType:e,tags:wpbc.preload.tags,account:this.model.get("account")},i=wpbc.preload.dates,s=this.model.get("date");void 0!==i&&void 0!==i[e]&&void 0!==i[e][s]&&(t.dates=i[e][s]),this.$el.html(this.template(t));var a=this.$el.find(".spinner");this.listenTo(wpbc.broadcast,"spinner:on",function(){a.addClass("is-active").removeClass("hidden")}),this.listenTo(wpbc.broadcast,"spinner:off",function(){a.removeClass("is-active").addClass("hidden")})},toggleList:function(){this.trigger("viewType","list"),this.$el.find(".view-list").addClass("current"),this.$el.find(".view-grid").removeClass("current")},toggleGrid:function(){this.trigger("viewType","grid"),this.$el.find(".view-grid").addClass("current"),this.$el.find(".view-list").removeClass("current")},toggleTooltip:function(){var e=wp.template("brightcove-tooltip-notice");$(".brightcove.media-frame-content").children().first().before(e),$("#js-tooltip-dismiss").on("click",function(){$("#js-tooltip-notice").first().fadeOut(500,function(){$(this).remove()})})},sourceChanged:function(e){this.model.set("account",e.target.value),wpbc.broadcast.trigger("change:activeAccount",e.target.value)},datesChanged:function(e){wpbc.broadcast.trigger("change:date",e.target.value)},tagsChanged:function(e){wpbc.broadcast.trigger("change:tag",e.target.value)},emptyPlaylistsChanged:function(e){var t=$(e.target).prop("checked");wpbc.broadcast.trigger("change:emptyPlaylists",t)},searchHandler:function(e){e.target.value.length>2?13===e.keyCode&&e.target.value!==this.model.get("search")?(this.model.set("search",e.target.value),wpbc.broadcast.trigger("change:searchTerm",e.target.value)):this.throttledAutoSearch(e):0===e.target.value.length&&(this.model.set("search",""),wpbc.broadcast.trigger("change:searchTerm",""))},throttledAutoSearch:_.debounce(function(e){e.target.value!==this.model.get("search")&&(this.model.set("search",e.target.value),wpbc.broadcast.trigger("change:searchTerm",e.target.value))},1e3)}),UploadVideoManagerView=BrightcoveView.extend({className:"brightcove-file-uploader",events:{"click .brightcove-start-upload":"triggerUpload"},initialize:function(e){this.collection=new UploadModelCollection,e&&(this.options=e,this.successMessage=e.successMessage||this.successMessage),this.uploadWindow=new UploadWindowView,this.listenTo(this.collection,"add",this.fileAdded),this.listenTo(wpbc.broadcast,"pendingUpload:selectedItem",this.selectedItem),this.listenTo(wpbc.broadcast,"uploader:prepareUpload",this.prepareUpload),this.listenTo(wpbc.broadcast,"uploader:successMessage",this.successMessage),this.listenTo(wpbc.broadcast,"uploader:errorMessage",this.errorMessage),this.listenTo(wpbc.broadcast,"uploader:clear",this.resetUploads),this.listenTo(wpbc.broadcast,"upload:video",this.resetUploads)},resetUploads:function(){for(;model=this.collection.first();)this.collection.remove(model)},errorMessage:function(e){this.message(e,"error")},successMessage:function(e){this.message(e,"success")},message:function(e,t){var i=this.$el.find(".brightcove-messages"),s="";"success"===t?s="notice updated":"error"===t&&(s="error");var a=$('<div class="wrap"><div class="brightcove-message"><p class="message-text"></p></div></div>');i.append(a),a.addClass(s).find(".message-text").text(e),a.delay(4e3).fadeOut(500,function(){$(this).remove(),wpbc.broadcast.trigger("upload:video")})},prepareUpload:function(){wpbc.uploads=wpbc.uploads||{},this.collection.each(function(e){wpbc.uploads[e.get("id")]={account:e.get("account"),name:e.get("fileName"),tags:e.get("tags")}}),wpbc.broadcast.trigger("uploader:startUpload")},fileAdded:function(e,t){1===this.collection.length&&this.render();var i=new UploadView({model:e});i.render(),i.$el.appendTo(this.$el.find(".brightcove-pending-uploads"))},triggerUpload:function(){wpbc.broadcast.trigger("uploader:prepareUpload")},selectedItem:function(e){this.uploadDetails=new UploadDetailsView({model:e}),this.uploadDetails.render(),this.$el.find(".brightcove-pending-upload-details").remove(),this.uploadDetails.$el.appendTo(this.$el.find(".brightcove-upload-queued-files"))},render:function(e){this.collection.length?this.template=wp.template("brightcove-uploader-queued-files"):(this.template=wp.template("brightcove-uploader-inline"),this.uploadWindow.render(),this.uploadWindow.$el.appendTo($("body"))),this.$el.html(this.template(e)),this.collection.length?this.$el.find(".brightcove-start-upload").show():this.$el.find(".brightcove-start-upload").hide()}}),BrightcoveRouter=Backbone.Router.extend({routes:{"add-new-brightcove-video":"addNew"},addNew:function(){wpbc.broadcast.trigger("upload:video")}}),BrightcoveMediaManagerView=BrightcoveView.extend({tagName:"div",className:"brightcove-media",events:{},scrollHandler:function(){wpbc.broadcast.trigger("scroll:mediaGrid")},initialize:function(e){var t=wp.media.isTouchDevice?300:200;this.scrollHandler=_.chain(this.scrollHandler).bind(this).throttle(t).value(),this.options=e,this.mode=e.mode||"manager",e.preload=!!this.options.preload&&wpbc.preload[this.options.mediaType],this.model=new BrightcoveMediaManagerModel(e),this.toolbar=new ToolbarView({model:this.model}),this.uploader=new UploadVideoManagerView,this.model.set("accounts",wpbc.preload.accounts),this.model.set("activeAccount",e.account),this.listenTo(this.toolbar,"viewType",function(e){this.model.set("view",e)}),this.listenTo(wpbc.broadcast,"videoEdit:message",this.message),this.listenTo(wpbc.broadcast,"permanent:message",this.permanentMessage),this.listenTo(wpbc.broadcast,"remove:permanentMessage",function(){wpbc.permanentMessage&&wpbc.permanentMessage.remove(),this.$el.find(".brightcove-message").addClass("hidden")}),this.listenTo(this.model,"change:view",function(e,t){this.model.get("media-collection-view").setViewType(t)}),this.listenTo(this.model,"change:mode",function(e,t){"uploader"!==t&&wpbc.broadcast.trigger("uploader:clear")}),this.listenTo(wpbc.broadcast,"cancelPreview:media",function(e){this.clearPreview(),this.detailsView=void 0,this.model.set("mode","manager"),this.render(),wpbc.broadcast.trigger("toggle:insertButton")}),this.listenTo(wpbc.broadcast,"change:emptyPlaylists",function(e){var t=this.model.get("media-collection-view");this.model.set("mode","manager"),_.each(t.collection.models,function(t){"EXPLICIT"===t.get("type")&&0===t.get("video_ids").length&&(e?t.view.$el.hide():t.view.$el.show())})}),this.listenTo(wpbc.broadcast,"delete:successful",function(e){this.startGridView(),this.message(e,"success")}),this.listenTo(wpbc.broadcast,"change:activeAccount",function(e){this.clearPreview(),this.model.set("activeAccount",e),this.model.set("mode","manager"),this.render()}),this.listenTo(wpbc.broadcast,"change:tag",function(e){this.clearPreview(),this.model.set("tag",e)}),this.listenTo(wpbc.broadcast,"change:date",function(e){this.clearPreview(),this.model.set("date",e)}),this.listenTo(wpbc.broadcast,"upload:video",function(){this.showUploader()}),this.listenTo(this.model,"change:search",function(e,t){this.model.get("search")}),this.listenTo(wpbc.broadcast,"start:gridview",function(){_.invoke(this.subviews,"remove"),this.detailsView=null,this.startGridView()}),this.listenTo(wpbc.broadcast,"tabChange",function(e){this.model.set(e),this.detailsView instanceof MediaDetailsView&&(this.detailsView.remove(),this.detailsView=void 0),this.render()}),this.listenTo(wpbc.broadcast,"edit:media",function(e){if("videos"===this.model.get("mediaType")){if("editVideo"===this.model.get("mode"))return!0;this.$el.find(".brightcove-message").addClass("hidden"),this.editView=new VideoEditView({model:e}),this.registerSubview(this.editView),this.model.set("mode","editVideo"),this.render()}else{if("editPlaylist"===this.model.get("mode"))return!0;this.editView=new PlaylistEditView({model:e}),this.registerSubview(this.editView),this.model.set("mode","editPlaylist"),this.render()}}),this.listenTo(wpbc.broadcast,"preview:media",function(e){if("videos"===this.model.get("mediaType")){if("previewVideo"===this.model.get("mode"))return!0;this.previewView=new VideoPreviewView({model:e}),this.registerSubview(this.previewView),this.model.set("mode","previewVideo"),this.render()}else this.model.set("mode","editPlaylist")}),this.listenTo(wpbc.broadcast,"change:searchTerm",function(e){this.clearPreview()}),this.listenTo(wpbc.broadcast,"select:media",function(e){this.detailsView&&this.detailsView.model===e.model?(this.detailsView.$el.toggle(),e.$el.toggleClass("highlighted"),this.model.get("media-collection-view").$el.toggleClass("menu-visible"),wpbc.broadcast.trigger("toggle:insertButton")):(this.clearPreview(),this.detailsView=new MediaDetailsView({model:e.model,el:$(".brightcove.media-frame-menu"),mediaType:this.model.get("mediaType")}),this.registerSubview(this.detailsView),this.detailsView.render(),this.detailsView.$el.toggle(!0),this.model.get("media-collection-view").$el.addClass("menu-visible"),e.$el.addClass("highlighted"),wpbc.broadcast.trigger("toggle:insertButton","enabled"))})},clearPreview:function(){this.detailsView instanceof MediaDetailsView&&this.detailsView.remove(),this.model.get("media-collection-view").$el.find(".highlighted").removeClass("highlighted")},startGridView:function(){this.model.set("mode","manager"),this.render()},message:function(e,t,i){var s=this.$el.find(".brightcove-message");"success"===t?(s.addClass("updated"),s.removeClass("error")):"error"===t&&(s.addClass("error"),s.removeClass("updated"));var a=$("<p></p>");a.text(e),s.append(a),s.removeClass("hidden"),i?(wpbc.permanentMessage&&wpbc.permanentMessage.remove(),wpbc.permanentMessage=a):(s.addClass("notice is-dismissible"),this.makeNoticesDismissible())},makeNoticesDismissible:function(){$(".notice.is-dismissible").each(function(){var e=$(this),t=$('<button type="button" class="notice-dismiss"><span class="screen-reader-text"></span></button>'),i=commonL10n.dismiss||"";t.find(".screen-reader-text").text(i),t.on("click.wp-dismiss-notice",function(t){t.preventDefault(),e.fadeTo(100,0,function(){e.slideUp(100,function(){e.addClass("hidden").css({opacity:1,"margin-bottom":0,display:""}).empty()})})}),e.append(t)})},showUploader:function(){this.model.set("mode","uploader"),this.render()},permanentMessage:function(e){this.message(e,"error",!0)},render:function(){var e,t=this.model.get("options"),i=this.model.get("mode");if(_.invoke(this.subviews,"remove"),"uploader"===i)this.template=wp.template("brightcove-uploader-container"),this.$el.empty(),this.$el.html(this.template(t)),this.uploader.render(),this.uploader.delegateEvents(),this.uploader.$el.appendTo($(".brightcove-uploader"));else if("manager"===i){this.template=wp.template("brightcove-media"),this.$el.html(this.template(t)),this.toolbar.render(),this.toolbar.delegateEvents(),this.toolbar.$el.show(),this.toolbar.$el.appendTo(this.$el.find(".media-frame-router"));var s=this.model.get("media-collection-view");s.render(),s.delegateEvents();var a=this.$el.find(".media-frame-content");a.on("scroll",this.scrollHandler),s.$el.appendTo(a),wpbc.initialSync&&(wpbc.broadcast.trigger("remove:permanentMessage"),wpbc.broadcast.trigger("permanent:message",wpbc.preload.messages.ongoingSync))}else"editVideo"===i?(this.toolbar.$el.hide(),(e=this.$el.find(".media-frame-content")).empty(),this.editView.render(),this.editView.delegateEvents(),this.editView.$el.appendTo(e),this.$el.find(".brightcove.media-frame-content").addClass("edit-view")):"editPlaylist"===i?(this.toolbar.$el.hide(),(e=this.$el).empty(),e.html('<div class="playlist-edit-container"></div>'),e=e.find(".playlist-edit-container"),this.editView.render(),this.editView.delegateEvents(),this.editView.$el.appendTo(e),e.addClass("playlist")):"previewVideo"===i&&(this.toolbar.$el.hide(),(e=this.$el.find(".media-frame-content")).empty(),this.previewView.render(),this.detailsView.render({detailsMode:"preview"}),this.previewView.delegateEvents(),this.previewView.$el.appendTo(e),this.$el.find(".brightcove.media-frame-toolbar").hide(),brightcove.createExperiences());return"editPlaylist"!==i&&this.$el.find(".media-frame-content").removeClass("playlist"),this}}),BrightcoveModalView=BrightcoveView.extend({tagName:"div",className:"media-modal brightcove",template:wp.template("brightcove-media-modal"),events:{"click .brightcove.media-menu-item":"changeTab","click .brightcove.media-button-insert":"insertIntoPost","click .brightcove.media-modal-icon":"closeModal","click .brightcove.save-sync":"saveSync","click .brightcove.button.back":"back"},initialize:function(e){this.model=new BrightcoveModalModel({tab:e.tab}),this.brightcoveMediaManager=new BrightcoveMediaManagerView(this.model.getMediaManagerSettings()),this.registerSubview(this.brightcoveMediaManager),this.listenTo(wpbc.broadcast,"toggle:insertButton",function(e){this.toggleInsertButton(e)}),this.listenTo(wpbc.broadcast,"close:modal",this.closeModal)},saveSync:function(e){wpbc.broadcast.trigger("save:media",e)},back:function(e){wpbc.broadcast.trigger("back:editvideo",e)},insertIntoPost:function(e){e.preventDefault(),$(e.currentTarget).hasClass("disabled")||(wpbc.selectedPlayer=$('input[name="video-player-field"]:checked').val(),wpbc.broadcast.trigger("insert:shortcode"))},toggleInsertButton:function(e){var t=this.$el.find(".brightcove.media-button-insert"),i=$(".attachment.highlighted").find(".processing").length;t.show(),1===i?t.attr("disabled","disabled"):"enabled"===e?t.removeAttr("disabled"):"disabled"===e?t.attr("disabled","disabled"):void 0!==t.attr("disabled")?t.removeAttr("disabled"):t.attr("disabled","disabled")},changeTab:function(e){if(e.preventDefault(),!$(e.target).hasClass("active")){$(e.target).addClass("active");var t=_.without(e.target.classList,"media-menu-item","brightcove")[0],i=["videos","upload","playlists"];_.each(_.without(i,t),function(e){$(".brightcove.media-menu-item."+e).removeClass("active")}),_.contains(i,t)&&(this.model.set("tab",t),wpbc.broadcast.trigger("spinner:off"),wpbc.broadcast.trigger("tabChange",this.model.getMediaManagerSettings()))}},closeModal:function(e){"editVideo"===wpbc.modal.brightcoveMediaManager.model.get("mode")&&wpbc.broadcast.trigger("start:gridview"),!_.isUndefined(e)&&$(e.currentTarget).parent().hasClass("disabled")||(this.$el.hide(),$("body").removeClass("modal-open"))},message:function(e){this.$el.find(".brightcove-message")},render:function(e){this.$el.html(this.template(e)),this.brightcoveMediaManager.render(),this.brightcoveMediaManager.$el.appendTo(this.$el.find(".media-frame-content")),this.listenTo(wpbc.broadcast,"edit:media",function(e,t){"videos"===t?(this.$el.find(".brightcove.button.save-sync").show(),this.$el.find(".brightcove.button.back").show(),this.$el.find(".brightcove.media-button-insert").hide()):(this.$el.find(".brightcove.button.save-sync").hide(),this.$el.find(".brightcove.button.back").hide(),this.$el.find(".brightcove.media-button-insert").hide())}),this.listenTo(wpbc.broadcast,"save:media back:editvideo start:gridView",function(){this.$el.find(".brightcove.button.save-sync").hide(),this.$el.find(".brightcove.button.back").hide(),this.$el.find(".brightcove.media-button-insert").show(),wpbc.broadcast.trigger("toggle:insertButton")})}}),MediaDetailsView=BrightcoveView.extend({tagName:"div",className:"media-details",attributes:function(){return{tabIndex:0,role:"checkbox","aria-label":this.model.get("title"),"aria-checked":!1,"data-id":this.model.get("id")}},events:{"click .brightcove.edit.button":"triggerEditMedia","click .brightcove.preview.button":"triggerPreviewMedia","click .brightcove.back.button":"triggerCancelPreviewMedia"},triggerEditMedia:function(e){e.preventDefault(),wpbc.broadcast.trigger("edit:media",this.model,this.mediaType)},triggerPreviewMedia:function(e){e.preventDefault(),wpbc.broadcast.trigger("preview:media",this.model)},triggerCancelPreviewMedia:function(e){wpbc.broadcast.trigger("cancelPreview:media",this.mediaType)},initialize:function(e){e=e||{},this.type=e.type?e.type:"grid",this.mediaType=e.mediaType,this.listenTo(wpbc.broadcast,"insert:shortcode",this.insertShortcode),this.listenTo(this.model,"change",this.render)},render:function(e){return e=_.extend({},e,this.model.toJSON()),e.duration=this.model.getReadableDuration(),e.updated_at_readable=this.model.getReadableDate("updated_at"),e.created_at_readable=this.model.getReadableDate("created_at"),e.account_name=this.model.getAccountName(),this.template=wp.template("brightcove-media-item-details-"+this.mediaType),this.$el.html(this.template(e)),this.delegateEvents(),this},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this}}),MediaView=BrightcoveView.extend({tagName:"li",className:"attachment brightcove",attributes:function(){return{tabIndex:0,role:"checkbox","aria-label":this.model.get("title"),"aria-checked":!1,"data-id":this.model.get("id")}},events:{"click .attachment-preview":"toggleDetailView","click .video-move-up":"videoMoveUp","click .video-move-down":"videoMoveDown","click .trash":"removeVideoFromPlaylist","click .add-to-playlist":"videoAdd","click .edit":"triggerEditMedia","click .preview":"triggerPreviewMedia"},triggerEditMedia:function(e){e.preventDefault(),wpbc.broadcast.trigger("edit:media",this.model)},triggerPreviewMedia:function(e){e.preventDefault(),wpbc.broadcast.trigger("preview:media",this.model)},buttons:{},initialize:function(e){e=e||{},this.type=e.type?e.type:"grid",this.listenTo(this.model,"change:view",function(e,t){this.type!==t&&(this.type=t,this.render())}),this.render()},render:function(){var e=this.model.toJSON();return e.duration=this.model.getReadableDuration(),e.updated_at_readable=this.model.getReadableDate("updated_at"),e.account_name=this.model.getAccountName(),"existingPlaylists"===e.viewType?this.template=wp.template("brightcove-playlist-edit-video-in-playlist"):"libraryPlaylists"===e.viewType?this.template=wp.template("brightcove-playlist-edit-video-in-library"):this.template=wp.template("brightcove-media-item-"+this.type),e.buttons=this.buttons,this.$el.html(this.template(e)),this.$el.toggleClass("uploading",e.uploading),this},toggleDetailView:function(){wpbc.broadcast.trigger("select:media",this)},videoMoveUp:function(){wpbc.broadcast.trigger("playlist:moveUp",this)},videoMoveDown:function(){wpbc.broadcast.trigger("playlist:moveDown",this)},videoAdd:function(){wpbc.broadcast.trigger("playlist:add",this)},removeVideoFromPlaylist:function(){wpbc.broadcast.trigger("playlist:remove",this)}}),PlaylistEditView=BrightcoveView.extend({tagName:"div",className:"playlist-edit brightcove attachment-details",template:wp.template("brightcove-playlist-edit"),events:{"click .brightcove.button.save-sync":"saveSync","click .brightcove.playlist-back":"back","change .brightcove-name":"updatedName"},deleteVideo:function(e){e.preventDefault(),this.model.set("mediaType","videos"),this.model.destroy()},updatedName:function(e){this.model.get("name")!==e.target.value&&(this.model.set("name",e.target.value),this.model.save())},back:function(e){e.preventDefault(),wpbc.broadcast.trigger("start:gridview")},saveSync:function(e){e.preventDefault(),this.model.set("name",this.$el.find(".brightcove-name").val()),this.model.set("description",this.$el.find(".brightcove-description").val()),this.model.set("long_description",this.$el.find(".brightcove-long-description").val()),this.model.set("tags",this.$el.find(".brightcove-tags").val()),this.model.set("mediaType","videos"),this.model.save()},initialize:function(){this.listenTo(wpbc.broadcast,"tabChange",function(){_.invoke(this.subviews,"remove")}),wpbc.broadcast.trigger("spinner:off")},render:function(e){e=this.model.toJSON(),this.$el.html(this.template(e)),this.spinner=this.$el.find(".spinner");this.$el.find(".existing-videos");e.video_ids&&(this.killPendingRequests(),this.playlistVideosView=new MediaCollectionView({el:this.$el.find(".existing-videos"),videoIds:e.video_ids,activeAccount:this.model.get("account_id"),mediaCollectionViewType:"existingPlaylists",mediaType:"playlists"}),this.libraryVideosView=new MediaCollectionView({el:this.$el.find(".library-videos"),excludeVideoIds:e.video_ids,activeAccount:this.model.get("account_id"),mediaCollectionViewType:"libraryPlaylists",mediaType:"playlists"}),this.registerSubview(this.playlistVideosView),this.registerSubview(this.libraryVideosView),this.listenTo(wpbc.broadcast,"playlist:changed",_.throttle(this.playlistChanged,300)),this.listenTo(wpbc.broadcast,"insert:shortcode",this.insertShortcode)),this.listenTo(wpbc.broadcast,"spinner:on",function(){this.spinner.addClass("is-active").removeClass("hidden")}),this.listenTo(wpbc.broadcast,"spinner:off",function(){this.spinner.removeClass("is-active").addClass("hidden")})},playlistChanged:function(e){this.killPendingRequests(),this.model.set("video_ids",e),this.model.save()},killPendingRequests:function(){_.each(wpbc.requests,function(e){e.abort()}),wpbc.requests=[]}}),UploadDetailsView=BrightcoveView.extend({className:"brightcove-pending-upload-details attachment-details",tagName:"div",template:wp.template("brightcove-pending-upload-details"),events:{"keyup .brightcove-name":"nameChanged","keyup .brightcove-tags":"tagsChanged","change .brightcove-media-source":"accountChanged"},initialize:function(e){this.listenTo(wpbc.broadcast,"pendingUpload:hideDetails",this.hide),this.listenTo(wpbc.broadcast,"uploader:fileUploaded",function(e){e.id===this.model.get("id")&&(this.model.set("uploaded",!0),this.render())}),this.model.set("ingestSuccess",!0),this.model.set("uploadSuccess",!0)},nameChanged:function(e){this.model.set("fileName",e.target.value)},tagsChanged:function(e){this.model.set("tags",e.target.value)},accountChanged:function(e){this.model.set("account",e.target.value)},hide:function(){this.$el.hide()},render:function(e){(e=e||{}).fileName=this.model.get("fileName"),e.tags=this.model.get("tags"),e.size=this.model.humanReadableSize(),e.accounts=this.model.get("accounts"),e.account=this.model.get("account"),e.uploaded=this.model.get("uploaded"),this.$el.html(this.template(e))}});UploadWindowView=BrightcoveView.extend({className:"uploader-window",template:wp.template("brightcove-uploader-window"),initialize:function(e){_.bindAll(this,"uploaderFilesAdded"),this.listenTo(wpbc.broadcast,"uploader:queuedFilesAdded",this.hide),this.listenTo(wpbc.broadcast,"uploader:startUpload",this.uploaderStartUpload),this.listenTo(wpbc.broadcast,"uploader:clear",this.resetUploads)},render:function(e){this.$el.html(this.template(e)),_.defer(_.bind(this.afterRender,this))},resetUploads:function(){this.uploader&&this.uploader.files&&(this.uploader.files=[])},afterRender:function(){this.uploader=new plupload.Uploader(_.defaults(this.options,wpbc.preload.plupload)),this.uploader.added=this.uploaderFilesAdded,this.uploader.progress=this.uploaderUploadProgress,this.uploader.bind("FilesAdded",this.uploaderFilesAdded),this.uploader.bind("UploadProgress",this.uploaderUploadProgress),this.uploader.bind("BeforeUpload",this.uploaderBeforeUpload),this.uploader.bind("FileUploaded",this.uploaderFileUploaded),this.uploader.bind("init",this.uploaderAfterInit),this.uploader.init(),$("html").on("dragenter",_.bind(this.show,this));var e=wpbc.preload.plupload.drop_element.replace(/[^a-zA-Z0-9-]+/g,"");$("#"+e).on("dropzone:leave",_.bind(this.hide,this))},uploaderAfterInit:function(e){var t,i,s,a=wpbc.preload.plupload.drop_element.replace(/[^a-zA-Z0-9-]+/g,""),o=$("#"+a);if(s=e.features.dragdrop,o){if(o.toggleClass("supports-drag-drop",!!s),!s)return o.unbind(".wp-uploader");o.bind("dragover.wp-uploader",function(){t&&clearTimeout(t),i||(o.trigger("dropzone:enter").addClass("drag-over"),i=!0)}),o.bind("dragleave.wp-uploader, drop.wp-uploader",function(){t=setTimeout(function(){i=!1,o.trigger("dropzone:leave").removeClass("drag-over")},0)})}},show:function(){var e=this.$el.show();_.defer(function(){e.css({opacity:1})})},hide:function(){var e=this.$el.css({opacity:0});wp.media.transition(e).done(function(){"0"===e.css("opacity")&&e.hide()}),_.delay(function(){"0"===e.css("opacity")&&e.is(":visible")&&e.hide()},500)},uploaderFilesAdded:function(e,t){wpbc.broadcast.trigger("uploader:queuedFilesAdded",t)},uploaderStartUpload:function(){this.uploader.start()},uploaderUploadProgress:function(e,t){wpbc.broadcast.trigger("uploader:uploadProgress",t)},uploaderBeforeUpload:function(e,t){e.settings.multipart_params=_.defaults(wpbc.uploads[t.id],wpbc.preload.plupload.multipart_params,{nonce:wpbc.preload.nonce})},uploaderFileUploaded:function(e,t,i){var s=JSON.parse(i.response);wpbc.broadcast.trigger("uploader:fileUploaded",t),"success"===s.data.upload&&"success"===s.data.ingest?(s.data.videoDetails&&wpbc.broadcast.trigger("uploader:uploadedFileDetails",s.data.videoDetails),wpbc.broadcast.trigger("uploader:successfulUploadIngest",t)):(t.percent=0,t.status=plupload.UPLOADING,e.state=plupload.STARTED,e.trigger("StateChanged"),wpbc.broadcast.trigger("uploader:failedUploadIngest",t))}});var UploadView=BrightcoveView.extend({className:"brightcove-pending-upload",tagName:"tr",template:wp.template("brightcove-pending-upload"),events:{click:"toggleRow"},initialize:function(){this.listenTo(wpbc.broadcast,"pendingUpload:selectedRow",this.otherToggledRow),this.listenTo(wpbc.broadcast,"uploader:uploadProgress",this.uploadProgress),this.listenTo(wpbc.broadcast,"uploader:getParams",this.getParams),this.listenTo(wpbc.broadcast,"uploader:successfulUploadIngest",this.successfulUploadIngest),this.listenTo(wpbc.broadcast,"uploader:failedUploadIngest",this.failedUploadIngest);var e={fileName:this.model.get("name"),tags:"",accounts:wpbc.preload.accounts,account:wpbc.preload.defaultAccount,ingestSuccess:!1,uploadSuccess:!1,uploaded:!1};this.model.set(e),this.listenTo(this.model,"change:fileName",this.render),this.listenTo(this.model,"change:account",this.render)},render:function(e){(e=e||{}).fileName=this.model.get("fileName"),e.size=this.model.humanReadableSize();var t=this.model.get("account");e.accountName=wpbc.preload.accounts[t].account_name,e.percent=this.model.get("percent"),e.activeUpload=this.model.get("activeUpload"),e.ingestSuccess=this.model.get("ingestSuccess"),e.uploadSuccess=this.model.get("uploadSuccess"),this.$el.html(this.template(e)),this.model.get("selected")&&this.$el.addClass("selected"),this.model.get("ingestSuccess")&&this.$el.addClass("ingest-success"),this.model.get("uploadSuccess")&&this.$el.addClass("upload-success")},getParams:function(e){wpbc.broadcast.trigger("uploader:params","abcde")},failedUploadIngest:function(e){e.id===this.model.get("id")&&(wpbc.broadcast.trigger("uploader:errorMessage",wpbc.preload.messages.unableToUpload.replace("%%s%%",this.model.get("fileName"))),this.render())},successfulUploadIngest:function(e){e.id===this.model.get("id")&&(wpbc.broadcast.trigger("uploader:successMessage",wpbc.preload.messages.successUpload.replace("%%s%%",this.model.get("fileName"))),this.render())},uploadProgress:function(e){e.id===this.model.get("id")?(this.model.set("activeUpload",!0),this.model.set("percent",e.percent),this.render()):this.model.get("activeUpload")&&(this.model.unset("activeUpload"),this.render())},toggleRow:function(e){this.$el.toggleClass("selected"),this.$el.hasClass("selected")?(this.model.set("selected",!0),wpbc.broadcast.trigger("pendingUpload:selectedRow",this.cid)):wpbc.broadcast.trigger("pendingUpload:hideDetails",this.cid)},otherToggledRow:function(e){e!==this.cid?(this.$el.removeClass("selected"),this.model.unset("selected")):wpbc.broadcast.trigger("pendingUpload:selectedItem",this.model)}}),VideoEditView=BrightcoveView.extend({tagName:"div",className:"video-edit brightcove attachment-details",template:wp.template("brightcove-video-edit"),events:{"click .brightcove.button.save-sync":"saveSync","click .brightcove.delete":"deleteVideo","click .brightcove.button.back":"back","click .setting .button":"openMediaManager","click .attachment .check":"removeAttachment","click .caption-secondary-fields .delete":"removeCaptionRow","click .add-remote-caption":"addCaptionRow"},back:function(e){e.preventDefault(),$(e.currentTarget).hasClass("disabled")||wpbc.broadcast.trigger("start:gridview")},deleteVideo:function(){confirm(wpbc.preload.messages.confirmDelete)&&(wpbc.broadcast.trigger("spinner:on"),this.model.set("mediaType","videos"),this.model.destroy())},openMediaManager:function(e){e.preventDefault();var t=$(e.currentTarget).parents(".setting").data("editor"),i=wp.media.frames.brightcove=wp.media(),s=this,a={state:"insert",title:wp.media.view.l10n.addMedia,multiple:!1};i.open(t,a),i.on("select",function(){var t=i.state().get("selection").first().toJSON(),a=$(e).parents(".setting");s.setAttachment(t,a),wpbc.broadcast.trigger("media:selected")})},setAttachment:function(e,t){var t=t.prevObject[0].currentTarget,i=(t=$(t).prev("input")).parents(".attachment"),s=i.find(".-image");if(i.context.className.indexOf("captions")>-1)if("vtt"===e.subtype)this.addCaptionRow(!1,e);else{var a=wp.template("brightcove-badformat-notice");$(".brightcove-media-videos").prepend(a),$(".badformat.notice-dismiss").on("click",function(){$(".notice.badformat").first().fadeOut(500,function(){$(this).remove()})})}else{var o={url:e.sizes.full.url,width:e.sizes.full.width,height:e.sizes.full.height},d=document.createElement("img");d.src=e.sizes.full.url,d.className="thumbnail",i.addClass("active"),s.html(d)}t.val(JSON.stringify(o))},removeAttachment:function(e){var t=$(e.currentTarget).parents(".attachment"),i=t.find(".-image");t.next("input").val(""),t.removeClass("active"),i.empty()},addCaptionRow:function(e,t){e&&e.preventDefault();var i=void 0;t&&(i=t.url),this.addCaption(i)},addCaption:function(e,t,i){var s=$(document.getElementById("js-caption-empty-row")).clone(),a=document.getElementById("js-captions");document.getElementById("js-caption-url");s.find("input").prop("disabled",!1),s.removeAttr("id"),s.removeClass("empty-row"),e&&s.find(".brightcove-captions").val(e),t&&s.find(".brightcove-captions-language").val(t),i&&s.find(".brightcove-captions-label").val(i),$(a).append(s),this.updateCaptionText()},removeCaptionRow:function(e){e.preventDefault();var t=e.currentTarget,i=$(t).parents(".caption-repeater"),s=i.find(".brightcove-captions"),a=i.find(".brightcove-captions-launguage"),o=i.find(".brightcove-captions-label");$(s).val(""),$(a).val(""),$(o).val(""),i.remove(),this.updateCaptionText()},updateCaptionText:function(){var e=$(".captions .button-secondary"),t=$(".add-remote-caption");1<document.getElementsByClassName("caption-repeater").length?(e.text(wpbc.str_addcaption),t.text(wpbc.str_addremote)):(e.text(wpbc.str_selectfile),t.text(wpbc.str_useremote))},saveSync:function(e){e.preventDefault();var t=$(e.currentTarget).parents(".media-modal"),i=t.find(".button, .button-link");if(!i.hasClass("disabled")){i.addClass("disabled"),t.find(".delete-action").hide(),wpbc.broadcast.trigger("spinner:on"),this.model.set("name",this.$el.find(".brightcove-name").val()),this.model.set("description",this.$el.find(".brightcove-description").val()),this.model.set("long_description",this.$el.find(".brightcove-long-description").val()),this.model.set("tags",this.$el.find(".brightcove-tags").val().trim().replace(/(^,)|(,$)/g,"")),this.model.set("height",this.$el.find(".brightcove-height").val()),this.model.set("width",this.$el.find(".brightcove-width").val()),this.model.set("mediaType","videos"),this.model.set("poster",this.$el.find(".brightcove-poster").val()),this.model.set("thumbnail",this.$el.find(".brightcove-thumbnail").val());var s=[];this.$el.find(".caption-repeater.repeater-row").not(".empty-row").each(function(){var e=$(this),t=e.find(".brightcove-captions").val(),i=t.split("?")[0];if("vtt"!==(i=i.split(".").pop())){var a=wp.template("brightcove-badformat-notice");return $(".brightcove-media-videos").prepend(a),void $(".badformat.notice-dismiss").on("click",function(){$(".notice.badformat").first().fadeOut(500,function(){$(this).remove()})})}s.push({source:t,language:e.find(".brightcove-captions-language").val(),label:e.find(".brightcove-captions-label").val()})}),this.model.set("captions",s);var a={},o=this.model.get("custom");_.each(this.$el.find(".brightcove-custom-string, .brightcove-custom-enum"),function(e){var t=e.getAttribute("data-id"),i=e.value.trim();""!==i&&(a[t]=i,_.find(o,function(e){return e.id==t}).value=i)}),this.model.set("custom_fields",a),this.model.set("custom",o),this.model.save().done(function(){if(t.length>0){var e,i,s=t.find(".brightcove-tags").val();s&&(e=s.split(","),i=_.difference(e,wpbc.preload.tags)),_.each(i,function(e){""!==(e=e.trim())&&wpbc.preload.tags.push(e)}),wpbc.preload.tags.sort()}}).always(function(){i.removeClass("disabled"),t.find(".delete-action").show()}),wpbc.broadcast.trigger("start:gridview")}},render:function(e){this.listenTo(wpbc.broadcast,"save:media",this.saveSync),this.listenTo(wpbc.broadcast,"back:editvideo",this.back),this.listenTo(wpbc.broadcast,"insert:shortcode",this.insertShortcode),e=this.model.toJSON(),this.$el.html(this.template(e));var t=this.$el.find("#brightcove-custom-fields"),i=wp.template("brightcove-video-edit-custom-string"),s=wp.template("brightcove-video-edit-custom-enum");_.each(this.model.get("custom"),function(e){if("_change_history"!==e.id)switch(e.type){case"string":t.append(i(e));break;case"enum":t.append(s(e))}});var a=this.model.get("history");if(void 0!==a){var o="";a=JSON.parse(a),_.each(a,function(e){o+=e.user+" - "+e.time+"\n"}),""!==o&&this.$el.find("textarea.brightcove-change-history").val(o)}var d=this.$el.find(".spinner");if(this.listenTo(wpbc.broadcast,"spinner:on",function(){d.addClass("is-active").removeClass("hidden")}),this.listenTo(wpbc.broadcast,"spinner:off",function(){d.removeClass("is-active").addClass("hidden")}),this.model.get("poster")&&this.displayAttachment("poster"),this.model.get("thumbnail")&&this.displayAttachment("thumbnail"),this.model.get("captions"))for(var n=this.model.get("captions"),l=0,r=n.length;l<r;l++){var c=n[l];this.addCaption(c.source,c.language,c.label)}}}),VideoPreviewView=BrightcoveView.extend({tagName:"div",className:"video-preview brightcove",template:wp.template("brightcove-video-preview"),render:function(e){(e=e||{}).id=this.model.get("id"),e.account_id=this.model.get("account_id"),this.$el.html(this.template(e)),this.listenTo(wpbc.broadcast,"insert:shortcode",this.insertShortcode)}}),MediaCollectionView=BrightcoveView.extend({tagName:"ul",className:"brightcove-media attachments",attributes:{tabIndex:-1},events:{scroll:"scrollHandler"},loadMoreMediaItems:function(){this.fetchingResults=!0,this.collection.fetch()},scrollHandler:function(){if("existingPlaylists"!==this.collection.mediaCollectionViewType){!this.fetchingResults&&this.el.scrollTop+this.el.clientHeight+200>this.el.scrollHeight&&(this.collection.pageNumber+=1,this.loadMoreMediaItems())}},initialize:function(e){this.fetchingResults=!1,this.listenTo(wpbc.broadcast,"fetch:finished",function(){this.fetchingResults=!1}),this.listenTo(wpbc.broadcast,"fetch:apiError",this.handleAPIError);var t=wp.media.isTouchDevice?300:200;this.scrollHandler=_.chain(this.scrollHandler).bind(this).throttle(t).value(),this.listenTo(wpbc.broadcast,"scroll:mediaGrid",this.scrollHandler),e=e||{},this.el.id=_.uniqueId("__attachments-view-"),!this.collection&&e.videoIds?(this.collection=new MediaCollection(null,{videoIds:e.videoIds,activeAccount:e.activeAccount,mediaCollectionViewType:e.mediaCollectionViewType}),this.listenTo(wpbc.broadcast,"playlist:moveUp",this.videoMoveUp),this.listenTo(wpbc.broadcast,"playlist:moveDown",this.videoMoveDown),this.listenTo(wpbc.broadcast,"playlist:remove",this.videoRemove),this.listenTo(wpbc.broadcast,"playlist:add",this.videoAdd)):this.collection||"libraryPlaylists"!==e.mediaCollectionViewType||(this.collection=new MediaCollection(null,{excludeVideoIds:e.excludeVideoIds,activeAccount:e.activeAccount,mediaCollectionViewType:e.mediaCollectionViewType}),this.listenTo(wpbc.broadcast,"playlist:remove",this.videoRemove),this.listenTo(wpbc.broadcast,"playlist:add",this.videoAdd)),_.defaults(this.options,{refreshSensitivity:wp.media.isTouchDevice?300:200,refreshThreshold:3,VideoView:wp.media.view.Video,sortable:!1,resize:!0,idealColumnWidth:202}),this._viewsByCid={},this.resizeEvent="resize.media-modal-columns",this.listenTo(this.collection,"add",function(e){this.views.add(this.createMediaView(e),{at:this.collection.indexOf(e)})},this),this.listenTo(this.collection,"remove",function(e){e&&(e.view?e.view.remove():e.cid&&this._viewsByCid[e.cid]&&this._viewsByCid[e.cid].remove())},this),this.listenTo(this.collection,"reset",this.render),this.scroll=_.chain(this.scroll).bind(this).throttle(this.options.refreshSensitivity).value(),this.options.scrollElement=this.options.scrollElement||this.el,$(this.options.scrollElement).on("scroll",this.scroll),_.bindAll(this,"setColumns"),this.options.resize&&(this.on("ready",this.bindEvents),_.defer(this.setColumns,this))},handleAPIError:function(){this.el.innerText=wpbc.str_apifailure},render:function(){this.listenTo(wpbc.broadcast,"spinner:off",function(){$("#js-media-loading").css("display","none")}),this.$el.empty(),this.collection.each(function(e){e.view=new MediaView({model:e}),this.registerSubview(e.view),e.view.render(),e.view.delegateEvents(),e.view.$el.appendTo(this.$el),wpbc.broadcast.trigger("spinner:off")},this)},setViewType:function(e){this.collection.each(function(t){t.set("view",e)},this)},bindEvents:function(){this.$window.off(this.resizeEvent).on(this.resizeEvent,_.debounce(this.setColumns,50))},setColumns:function(){var e=this.columns,t=this.$el.width();t&&(this.columns=Math.min(Math.round(t/this.options.idealColumnWidth),12)||1,e&&e===this.columns||this.$el.closest(".media-frame-content").attr("data-columns",this.columns))},createMediaView:function(e){e.set("viewType",this.collection.mediaCollectionViewType);var t=new MediaView({controller:this.controller,model:e,collection:this.collection,selection:this.options.selection});return this.registerSubview(t),this._viewsByCid[e.cid]=t,t},prepare:function(){this.collection.length?this.views.set(this.collection.map(this.createMediaView,this)):(this.views.unset(),this.collection.more().done(this.scroll))},ready:function(){this.scroll()},scroll:function(){var e,t=this,i=this.options.scrollElement,s=i.scrollTop;i===document&&(i=document.body,s=$(document).scrollTop()),"function"===this.collection.hasMore&&$(i).is(":visible")&&this.collection.hasMore()&&(e=this.views.parent.toolbar,i.scrollHeight-(s+i.clientHeight)<i.clientHeight/3&&e.get("spinner").show(),i.scrollHeight<s+i.clientHeight*this.options.refreshThreshold&&this.collection.more().done(function(){t.scroll(),e.get("spinner").hide()}))},videoMoveUp:function(e){var t=e.model,i=this.collection.indexOf(t);i>0&&(this.collection.remove(t,{silent:!0}),this.collection.add(t,{at:i-1})),this.render(),this.playlistChanged()},videoMoveDown:function(e){var t=e.model,i=this.collection.indexOf(t);i<this.collection.models.length&&(this.collection.remove(t,{silent:!0}),this.collection.add(t,{at:i+1})),this.render(),this.playlistChanged()},videoRemove:function(e){var t=e.model;-1===this.collection.indexOf(t)?this.collection.add(t):(this.collection.remove(t,{silent:!0}),this.playlistChanged()),this.render()},videoAdd:function(e){var t=e.model;-1===this.collection.indexOf(t)?(this.collection.add(t),this.playlistChanged()):(this.collection.remove(t,{silent:!0}),this.render())},playlistChanged:function(){var e=[];this.collection.each(function(t){e.push(t.id)}),this.videoIds=e,this.syncPlaylist()},syncPlaylist:function(){wpbc.broadcast.trigger("playlist:changed",this.videoIds)}}),App={renderMediaManager:function(e){var t=$(".brightcove-media-"+e);document.getElementById("content_ifr");t.length&&new BrightcoveMediaManagerView({el:t,date:"all",embedType:"page",preload:!0,mode:"manager",search:"",accounts:"all",tags:"all",mediaType:e,viewType:"grid"}).render()},load:function(){wpbc.requests=[],wpbc.responses={},wpbc.broadcast=_.extend({},Backbone.Events),this.loaded()},loaded:function(){var e=$(".brightcove-modal"),t=new BrightcoveRouter;wpbc.triggerModal=function(){wpbc.modal?wpbc.modal.$el.show():(wpbc.modal=new BrightcoveModalView({el:e,tab:"videos"}),wpbc.modal.render(),wpbc.modal.$el.find(".spinner").addClass("is-active")),$("body").addClass("modal-open")};_.each(["videos","playlists"],function(e){App.renderMediaManager(e)}),$(".account-toggle-button").on("click",function(e){e.preventDefault(),$(this).hide(),$(".brightcove-account-row.hidden").show()}),$(".brightcove-add-new-video").on("click",function(e){e.preventDefault(),t.navigate("add-new-brightcove-video",{trigger:!0})}),$(document).on("click",".brightcove-add-media",function(e){e.preventDefault(),wpbc.triggerModal()}),$(document).keyup(function(e){27===e.keyCode&&wpbc.broadcast.trigger("close:modal")}),$("a.brightcove-action-delete-source").on("click",function(e){var t=$(this).data("alert-message");if(!confirm(t))return!1})}};jQuery(document).ready(function(){App.load();new BrightcoveRouter;Backbone.history.start()});
} )( jQuery );